generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Device {
  id              Int      @id @default(autoincrement()) @db.UnsignedInt
  name            String?
  ip              String?
  username        String?
  password        String?
  loc             String?
  channel         Int?     @db.UnsignedTinyInt
  last_event_sync DateTime @default(now())
  last_user_sync  DateTime @default(now())
  port            Int?     @default(51211) @db.UnsignedInt
  isActive        Boolean  @default(true)
  status          String?  @default("disconnected")
  useSSL          Boolean  @default(false)

  enrollments     DeviceEnrollment[]

  @@map("device")
}

model GateEvent {
  id              Int       @id @default(autoincrement()) @db.UnsignedInt
  employee_id     String?   @db.Char(20)
  door_no         Int?      @db.UnsignedInt
  gate_id         Int?      @db.UnsignedInt
  loc             String?   @db.Char(15)
  dir             String?   @db.Char(5)
  etime           DateTime?
  etime_truncated String?   @db.VarChar(16)
  d               DateTime? @db.Date
  t               DateTime? @db.Time(0)

  @@index([etime], map: "etime")
  @@index([gate_id], map: "gate_id")
  @@index([employee_id], map: "index_foreignkey_gateevents_employee")
  @@map("gateevents")
}

model User {
  id           Int    @id @default(autoincrement())
  username     String @db.VarChar(300)
  userpassword String @db.VarChar(300)
  displayname  String @db.VarChar(300)

  @@map("user")
}

model TempAccess {
  id            Int      @id @default(autoincrement()) @db.UnsignedInt
  solutionnname String?
  person_name   String?
  date          String?
  qrcode        Float?
  email         String?
  drive_id      String?  @db.VarChar(100)
  done          Boolean  @default(false)
  host          String?  @db.VarChar(5000)
  ts            DateTime @default(now())

  @@map("tempaccess")
}

// Card assignments - links cards to employees
model CardAssignment {
  id            Int       @id @default(autoincrement())
  employeeId    String    @db.VarChar(50)  // References HR employee ID
  employeeName  String?   @db.VarChar(255) // Cached employee name for quick lookup
  cardData      String    @db.VarChar(255) // CSN/card data (base64 or hex)
  cardType      String    @default("CSN") @db.VarChar(50) // CSN, SmartCard, QR, etc.
  cardFormat    Int       @default(0)      // Card format type from Suprema
  status        String    @default("active") @db.VarChar(20) // active, revoked, lost, expired
  assignedAt    DateTime  @default(now())
  revokedAt     DateTime?
  notes         String?   @db.Text

  enrollments   DeviceEnrollment[]

  @@unique([cardData])
  @@index([employeeId])
  @@index([status])
  @@map("card_assignments")
}

// Device enrollments - tracks which employees are enrolled on which devices
model DeviceEnrollment {
  id              Int       @id @default(autoincrement())
  deviceId        Int       @db.UnsignedInt  // FK to Device
  cardAssignmentId Int       // FK to CardAssignment
  deviceUserId    String    @db.VarChar(50) // User ID on the Suprema device
  enrolledAt      DateTime  @default(now())
  lastSyncAt      DateTime?
  status          String    @default("active") @db.VarChar(20) // active, removed, pending

  device          Device    @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  cardAssignment  CardAssignment @relation(fields: [cardAssignmentId], references: [id], onDelete: Cascade)

  @@unique([deviceId, cardAssignmentId])
  @@unique([deviceId, deviceUserId])
  @@index([status])
  @@map("device_enrollments")
}
