generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Location tree structure for organizing devices
model Location {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(100)
  description String?   @db.Text
  parentId    Int?      // Self-referential for tree structure
  level       Int       @default(0)  // 0=root, 1=building, 2=floor, 3=zone, etc.
  locationType String   @default("zone") @db.VarChar(50) // building, floor, zone, room, gate
  sortOrder   Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Self-referential relationship
  parent      Location?  @relation("LocationTree", fields: [parentId], references: [id], onDelete: SetNull)
  children    Location[] @relation("LocationTree")
  
  // Devices at this location
  devices     Device[]

  @@index([parentId])
  @@index([locationType])
  @@map("locations")
}

model Device {
  id              Int      @id @default(autoincrement()) @db.UnsignedInt
  name            String?
  ip              String?
  username        String?
  password        String?
  loc             String?
  channel         Int?     @db.UnsignedTinyInt
  last_event_sync DateTime @default(now())
  last_user_sync  DateTime @default(now())
  port            Int?     @default(51211) @db.UnsignedInt
  isActive        Boolean  @default(true)
  status          String?  @default("disconnected")
  useSSL          Boolean  @default(false)
  
  // New fields for device tree
  locationId      Int?     // FK to Location
  direction       String   @default("in") @db.VarChar(10) // 'in' or 'out'
  deviceType      String?  @db.VarChar(50) // reader, controller, terminal
  serialNumber    String?  @db.VarChar(100)
  
  // Relation to Location
  location        Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)

  enrollments     DeviceEnrollment[]

  @@index([locationId])
  @@index([direction])
  @@map("device")
}

model GateEvent {
  id              Int       @id @default(autoincrement()) @db.UnsignedInt
  employee_id     String?   @db.Char(20)
  door_no         Int?      @db.UnsignedInt
  gate_id         Int?      @db.UnsignedInt
  loc             String?   @db.Char(15)
  dir             String?   @db.Char(5)
  etime           DateTime?
  etime_truncated String?   @db.VarChar(16)
  d               DateTime? @db.Date
  t               DateTime? @db.Time(0)

  @@index([etime], map: "etime")
  @@index([gate_id], map: "gate_id")
  @@index([employee_id], map: "index_foreignkey_gateevents_employee")
  @@map("gateevents")
}

model User {
  id           Int    @id @default(autoincrement())
  username     String @db.VarChar(300)
  userpassword String @db.VarChar(300)
  displayname  String @db.VarChar(300)

  @@map("user")
}

model TempAccess {
  id            Int      @id @default(autoincrement()) @db.UnsignedInt
  solutionnname String?
  person_name   String?
  date          String?
  qrcode        Float?
  email         String?
  drive_id      String?  @db.VarChar(100)
  done          Boolean  @default(false)
  host          String?  @db.VarChar(5000)
  ts            DateTime @default(now())

  @@map("tempaccess")
}

// Card assignments - links cards to employees
model CardAssignment {
  id            Int       @id @default(autoincrement())
  employeeId    String    @db.VarChar(50)  // References HR employee ID
  employeeName  String?   @db.VarChar(255) // Cached employee name for quick lookup
  cardData      String    @db.VarChar(255) // CSN/card data (base64 or hex)
  cardSize      Int       @default(0)      // Original card data size in bytes
  cardType      String    @default("CSN") @db.VarChar(50) // CSN, SmartCard, QR, etc.
  cardFormat    Int       @default(0)      // Card format type from Suprema
  status        String    @default("active") @db.VarChar(20) // active, revoked, lost, expired
  assignedAt    DateTime  @default(now())
  revokedAt     DateTime?
  notes         String?   @db.Text

  enrollments   DeviceEnrollment[]

  @@unique([cardData])
  @@index([employeeId])
  @@index([status])
  @@map("card_assignments")
}

// Device enrollments - tracks which employees are enrolled on which devices
model DeviceEnrollment {
  id              Int       @id @default(autoincrement())
  deviceId        Int       @db.UnsignedInt  // FK to Device
  cardAssignmentId Int       // FK to CardAssignment
  deviceUserId    String    @db.VarChar(50) // User ID on the Suprema device
  enrolledAt      DateTime  @default(now())
  lastSyncAt      DateTime?
  status          String    @default("active") @db.VarChar(20) // active, removed, pending

  device          Device    @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  cardAssignment  CardAssignment @relation(fields: [cardAssignmentId], references: [id], onDelete: Cascade)

  @@unique([deviceId, cardAssignmentId])
  @@unique([deviceId, deviceUserId])
  @@index([status])
  @@map("device_enrollments")
}

// Synced events from devices
model Event {
  id            Int       @id @default(autoincrement())
  deviceId      Int       @db.UnsignedInt  // Device database ID
  supremaEventId BigInt   // Event ID from Suprema device
  eventCode     Int       // Event code (hex)
  eventType     String    @db.VarChar(50)  // authentication, door, zone, system, user, attendance
  subType       String?   @db.VarChar(50)  // More specific type
  userId        String?   @db.VarChar(50)  // User ID if applicable
  doorId        Int?      // Door ID if applicable
  description   String?   @db.VarChar(500) // Human-readable description
  authResult    String?   @db.VarChar(20)  // success, fail, etc.
  timestamp     DateTime  // Event timestamp from device
  syncedAt      DateTime  @default(now())  // When we synced this event
  rawData       Json?     // Full event data from device

  @@unique([deviceId, supremaEventId])
  @@index([deviceId])
  @@index([eventType])
  @@index([userId])
  @@index([timestamp])
  @@index([authResult])
  @@map("events")
}

// Enrollment debug logs - stores verbose logging for troubleshooting
model EnrollmentLog {
  id              Int       @id @default(autoincrement())
  operation       String    @db.VarChar(50)  // setUserCards, enrollUsers, scanCard, etc.
  deviceId        Int?      // Device ID (numeric)
  userId          String?   @db.VarChar(50)  // User ID being enrolled
  cardDataHex     String?   @db.VarChar(512) // Hex representation of card data
  cardSize        Int?      // Card size in bytes
  cardType        Int?      // Card type code
  bufferLength    Int?      // Actual buffer length
  requestPayload  Json?     // Full request payload (serialized)
  responsePayload Json?     // Response payload or error
  success         Boolean   @default(false)
  errorMessage    String?   @db.Text
  createdAt       DateTime  @default(now())

  @@index([deviceId])
  @@index([operation])
  @@index([success])
  @@index([createdAt])
  @@map("enrollment_logs")
}
