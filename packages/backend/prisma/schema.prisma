// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Device {
  id                String   @id @default(cuid())
  name              String   @db.VarChar(100)
  description       String?  @db.Text
  ip                String   @db.VarChar(15)
  port              Int
  useSSL            Boolean  @default(false) @map("use_ssl")
  deviceType        String?  @db.VarChar(50) @map("device_type")
  serialNumber      String?  @unique @db.VarChar(100) @map("serial_number")
  firmwareVersion   String?  @db.VarChar(50) @map("firmware_version")
  location          String?  @db.VarChar(200)
  isActive          Boolean  @default(true) @map("is_active")
  isConnected       Boolean  @default(false) @map("is_connected")
  lastConnected     DateTime? @map("last_connected")
  connectionRetries Int      @default(0) @map("connection_retries")
  maxRetries        Int      @default(3) @map("max_retries")
  timeout           Int      @default(30000)
  capabilities      Json?
  settings          Json?
  status            DeviceStatus @default(active)
  lastError         String?  @db.Text @map("last_error")
  errorCount        Int      @default(0) @map("error_count")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  users             User[]
  events            Event[]
  doors             Door[]
  tnaLogs           TNALog[]

  @@unique([ip, port])
  @@index([isActive])
  @@index([status])
  @@index([isConnected])
  @@map("devices")
}

model User {
  id                String   @id @default(cuid())
  userID            String   @unique @db.VarChar(50) @map("user_id")
  name              String   @db.VarChar(100)
  email             String?  @db.VarChar(255)
  phone             String?  @db.VarChar(20)
  department        String?  @db.VarChar(100)
  position          String?  @db.VarChar(100)
  employeeNumber    String?  @db.VarChar(50) @map("employee_number")
  startWorkTime     String?  @db.VarChar(8) @map("start_work_time")
  endWorkTime       String?  @db.VarChar(8) @map("end_work_time")
  isActive          Boolean  @default(true) @map("is_active")
  accessGroupIds    Json?    @map("access_group_ids")
  biometricData     Json?    @map("biometric_data")
  cardNumber        String?  @db.VarChar(50) @map("card_number")
  pin               String?  @db.VarChar(10)
  faceTemplate      Bytes?   @map("face_template")
  fingerprintTemplate Bytes? @map("fingerprint_template")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  // Relations
  deviceId          String   @map("device_id")
  device            Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  events            Event[]
  tnaLogs           TNALog[]

  @@index([userID])
  @@index([isActive])
  @@index([deviceId])
  @@map("users")
}

model Event {
  id          String    @id @default(cuid())
  eventCode   Int       @map("event_code")
  eventName   String    @db.VarChar(100) @map("event_name")
  eventTime   DateTime  @map("event_time")
  userID      String?   @db.VarChar(50) @map("user_id")
  doorID      String?   @db.VarChar(50) @map("door_id")
  cardNumber  String?   @db.VarChar(50) @map("card_number")
  tnaKey      Int?      @map("tna_key")
  jobCode     Int?      @map("job_code")
  imageData   Bytes?    @map("image_data")
  isProcessed Boolean   @default(false) @map("is_processed")
  metadata    Json?
  createdAt   DateTime  @default(now()) @map("created_at")
  
  // Relations
  deviceId    String    @map("device_id")
  device      Device    @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  user        User?     @relation(fields: [userID], references: [userID])

  @@index([eventCode])
  @@index([eventTime])
  @@index([userID])
  @@index([deviceId])
  @@index([isProcessed])
  @@map("events")
}

model Door {
  id            String   @id @default(cuid())
  doorID        String   @unique @db.VarChar(50) @map("door_id")
  name          String   @db.VarChar(100)
  description   String?  @db.Text
  location      String?  @db.VarChar(200)
  doorType      String?  @db.VarChar(50) @map("door_type")
  isLocked      Boolean  @default(true) @map("is_locked")
  autoLockTime  Int?     @map("auto_lock_time")
  holdOpenTime  Int?     @map("hold_open_time")
  alarmDelay    Int?     @map("alarm_delay")
  isActive      Boolean  @default(true) @map("is_active")
  settings      Json?
  schedules     Json?
  accessLevels  Json?    @map("access_levels")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Relations
  deviceId      String   @map("device_id")
  device        Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([doorID])
  @@index([isActive])
  @@index([deviceId])
  @@map("doors")
}

model TNALog {
  id            String   @id @default(cuid())
  userID        String   @db.VarChar(50) @map("user_id")
  eventTime     DateTime @map("event_time")
  tnaKey        Int      @map("tna_key")
  tnaEvent      Int      @map("tna_event")
  jobCode       Int?     @map("job_code")
  workHours     Float?   @map("work_hours")
  overTimeHours Float?   @map("overtime_hours")
  breakTime     Int?     @map("break_time")
  isProcessed   Boolean  @default(false) @map("is_processed")
  processedAt   DateTime? @map("processed_at")
  metadata      Json?
  createdAt     DateTime @default(now()) @map("created_at")
  
  // Relations
  deviceId      String   @map("device_id")
  device        Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userID], references: [userID])

  @@index([userID])
  @@index([eventTime])
  @@index([tnaKey])
  @@index([deviceId])
  @@index([isProcessed])
  @@map("tna_logs")
}

model AccessLevel {
  id          String   @id @default(cuid())
  name        String   @db.VarChar(100)
  description String?  @db.Text
  doorIds     Json     @map("door_ids")
  schedules   Json?
  userGroups  Json?    @map("user_groups")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([isActive])
  @@map("access_levels")
}

model Schedule {
  id          String   @id @default(cuid())
  name        String   @db.VarChar(100)
  description String?  @db.Text
  schedule    Json     // Contains time periods, days of week, holidays
  timezone    String?  @db.VarChar(50)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([isActive])
  @@map("schedules")
}

model SystemLog {
  id        String    @id @default(cuid())
  level     LogLevel
  message   String    @db.Text
  metadata  Json?
  source    String?   @db.VarChar(100)
  timestamp DateTime  @default(now())

  @@index([level])
  @@index([timestamp])
  @@index([source])
  @@map("system_logs")
}

model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique @db.VarChar(100)
  value     String   @db.Text
  category  String   @db.VarChar(50)  // gateway, device, system, etc.
  description String? @db.Text
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([category])
  @@index([isActive])
  @@map("system_config")
}

enum DeviceStatus {
  active
  inactive
  error
  maintenance
}

enum LogLevel {
  error
  warn
  info
  debug
}